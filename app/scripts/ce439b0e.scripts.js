"use strict";angular.module("DashbookApp",[]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{dashes:["Dashloader",function(a){return a()}]}}).otherwise({redirectTo:"/"})}]).run(["$http",function(a){window.addEventListener("beforeunload",function(){a.post("/exit").success(function(){}).error(function(){})})}]),angular.module("DashbookApp").controller("MainCtrl",["$scope","dashes","$rootScope",function(a,b,c){c.myDashes=b,c.safeApply=function(){"$apply"!=c.$$phase&&"$digest"!=c.$$phase&&c.$apply()},c.addDash=function(a){c.myDashes?(c.myDashes.unshift(a),c.myDashList=c.myDashList||[],c.myDashList.unshift(a._id)):(c.myDashes=[],c.myDashes.push(a),c.myDashList=[],c.myDashList.push(a._id)),localStorage.myDashList=JSON.stringify(c.myDashList)},c.deleteDash=function(a){c.myDashes.indexOf(a),c.myDashes&&(c.myDashes.splice(c.myDashes.indexOf(a),1),c.myDashList.splice(c.myDashList.indexOf(a._id),1),localStorage.myDashList=JSON.stringify(c.myDashList),c.safeApply())},c.reArrange=function(a){c.myDashList=a,localStorage.myDashList=JSON.stringify(a),console.log(localStorage.myDashList)}}]),angular.module("DashbookApp").factory("Dashloader",["$http","$q","$rootScope",function(a,b,c){return function(){var d=document.cookie;if(d){d=d.replace(" ","");var e=d.split(";");for(var f in e){var g=e[f].split("=")[0],h=e[f].split("=")[1];c[g]=h}}var i="/dashes/amir";if(localStorage.myDashList){c.myDashList=JSON.parse(localStorage.myDashList),i+="?";var j=localStorage.myDashList;j=JSON.parse(j);for(var f=0;f<j.length;++f)i+=f+"="+j[f]+"&"}var k=b.defer();return a.get(i).success(function(a){if(c.myDashList){for(var b,d=[],e=0;e<c.myDashList.length;++e){for(var f=0;f<a.length;++f)c.myDashList[e]==a[f]._id&&(d.push(a[f]),b=f);a.splice(b,1)}k.resolve(d)}}).error(function(a){k.reject(a)}),k.promise}}]),angular.module("DashbookApp").directive("dash",["$http","$timeout",function(a,b){return{restrict:"E",replace:!0,templateUrl:"/partials/dash.html",link:function(c){function d(a){return a?"addClass":"removeClass"}c.scalar=250,c.unit="M",c.skip=0,"geo"==c.d.type&&($(".cell").each(function(a){a.addClass("middle")}),$(".table").addClass("centered"),$(".table").addClass("location")),a.get("/content?t="+c.d.title+"&s="+c.d.selectedSetting+"&skip="+c.skip).success(function(a){c.d.content=a.content,c.skip=a.skip,c.safeApply(),$("#"+c.d._id+" .spinner").hide()}).error(function(a){throw a});var e=!1;$(document).on("input",".clearable",function(){$(this)[d(this.value)]("x")}).on("mousemove",".x",function(a){$(this)[d(this.offsetWidth-25<a.clientX-this.getBoundingClientRect().left)]("onX")}).on("click",".onX",function(){$(this).removeClass("x onX").val("")}),c.updateInputText=function(){if($("#"+c.d._id+"-input-text").val()){if(c.d.selectedSetting==$("#"+c.d._id+"-input-text").val())return;c.d.selectedSetting=$("#"+c.d._id+"-input-text").val(),a.post("/dashes/"+c.d._id+"/settings",{textInput:$("#"+c.d._id+"-input-text").val(),uuid:"amir",settingType:"textInput"}).success(function(){console.log("done")}).error(function(a){console.log(a)})}},c.selectSetting=function(d){var e=(new Date).getTime();c.flipSettings(),$("#"+c.d._id+" .spinner").show(),c.d.selectedSetting=c.d.settings[d],a.post("/dashes/"+c.d._id+"/settings",{selectedSetting:c.d.selectedSetting,uuid:"amir",settingType:"radio"}).success(function(a){(new Date).getTime()-e>1e3?($("#"+c.d._id).addClass("loading"),c.d.content=a,$("#"+c.d._id+" .spinner").hide(),c.safeApply()):b(function(){c.d.content=a,$("#"+c.d._id).removeClass("loading"),$("#"+c.d._id+" .spinner").hide(),c.safeApply()},1e3-((new Date).getTime()-e))}).error(function(a){console.log(a)})},c.flipSettings=function(){e?$("#"+c.d._id).removeClass("flip"):$("#"+c.d._id).addClass("flip"),e=!e},c.removeDash=function(){return c.d.removeRequested?(c.d.removeRequested=!0,$(document).find(".expand").removeClass("expand"),$("#"+c.d._id+"-remove-btn").addClass("expand"),a.delete("/dashes/"+c.d._id).success(function(){c.deleteDash(c.d)}).error(function(a){console.log(a)}),void 0):(c.d.removeRequested=!0,$(document).find(".expand").removeClass("expand"),$("#"+c.d._id+"-remove-btn").addClass("expand"),void 0)},c.uriOpened=function(a){console.log(a,c.d)}}}}]),angular.module("DashbookApp").directive("dbkWrapper",["$rootScope",function(){return{templateUrl:"/partials/dbk-wrapper.html",restrict:"E",link:function(a){a.showLibrary=function(){$(".dbk-wrapper").toggleClass("push-screen")}}}}]),angular.module("DashbookApp").directive("inputClearable",[function(){return{restrict:"A",link:function(){}}}]),angular.module("DashbookApp").directive("library",["$http",function(a){return{templateUrl:"/partials/library.html",restrict:"E",link:function(b){a.get("/dashes").success(function(a){b.dashes=a}).error(function(a){console.log(a)}),b.add=function(c){return c.addRequested?(c.addRequested=!1,$(document).find(".expand").removeClass("expand"),a.put("/dashes/"+c._id+"/amir").success(function(a){b.addDash(a),b.safeApply()}).error(function(a){console.log(a)}),void 0):(c.addRequested=!0,$(document).find(".expand").removeClass("expand"),$("#"+c._id+"-lib-add-btn").addClass("expand"),void 0)}}}}]),angular.module("DashbookApp").directive("sortable",[function(){return{restrict:"A",link:function(a,b){function c(){var b=[];$("article").each(function(){$(this).attr("id")&&-1==b.indexOf($(this).attr("id"))&&(console.log($(this).attr("id")),b.push($(this).attr("id")))}),a.reArrange(b)}$(b).sortable({items:"> article"}),$(b).disableSelection(),b.bind("sortchange",function(){setTimeout(c,1e3)})}}}]),angular.module("DashbookApp").filter("time",["$filter",function(a){return function(b){var b=new Date(b).getTime();if(b=parseInt(b),isNaN(b))return"BAD INPUT!";var c=new Date,d=new Date(b),e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0);var f=" at "+(0==d.getHours()?"00":12==d.getHours()?"12":24==d.getHours()?"00":d.getHours()%12)+":"+(d.getMinutes()<10?"0":"")+d.getMinutes()+(d.getHours()<12?" AM":" PM");if(d.getFullYear()!=c.getFullYear())return a("date")(b,"MMM d y")+f;var g=c.getTime()-b,h=new Date(g),i=c.getTime()-e.getTime(),j=Math.floor(g/36e5),k=h.getMinutes(),l=h.getSeconds(),m=Math.floor(j/24);if(m>0){if(1==m){var n=new Date(e.getTime()-864e5);return n>b?a("date")(b,"EEEE")+f:"Yesterday"+f}return 7>m?a("date")(b,"EEEE")+f:a("date")(b,"MMM d")+f}return g>i?"Yesterday"+f:j>1?j+" hours ago":1==j?"1 hour ago":k>1?k+" minutues ago":1==k?"1 minutue ago":l>1?l+" seconds ago":1==l?"1 second ago":"1 second ago"}}]);